# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: ubuntu/deb build x64

on:
  workflow_dispatch:

jobs:
  job0:
    runs-on: ubuntu-latest

    steps:
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.SKITPICKEL }}
        with: 
          draft: true
          prerelease: true
          release_name: alpha 0.0.1
          tag_name: alpha
          body: alpha test realease
      - run: echo ${{ steps.create_release.outputs.upload_url }} | tee uploadPath.txt
      - name: Upload path for other jobs
        uses: actions/upload-artifact@v3
        with:
          name: path
          path: uploadPath.txt
  job1:
    needs: job0
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
        - uses: actions/checkout@v2
        - name: Set up JDK 16
          uses: actions/setup-java@v2
          with:
            java-version: '16'
            distribution: 'temurin'
            cache: maven
          
        - run: mkdir -p src/main/resources/daemon
      
        - name: download daemon
          uses: duhow/download-github-release-assets@v1
          with:
            repository: unigrid-project/daemon
            release-id: latest
            files: unigrid-*-x86_64-linux-gnu.tar.gz
            target: unigridd.tar.gz
        - name: Extract
          run: | 
            tar -xvf unigridd.tar.gz && cp unigrid-*/bin/unigridd src/main/resources/daemon
          
        - name: Build with Maven
          run: mvn install
        
        - run: mkdir staging && cp target/release/*.* staging
      
        - name: Download path from job0
          uses: actions/download-artifact@v3
          with:
            name: path
        - shell: bash
          run: |
            value='cat uploadPath.txt'
        - name: Upload release assets
          id: upload_realse_assets
          uses: actions/upload_release_asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.SKITPICKEL }}
          with:
            upload_url: value
            asset_path: ./staging/janus_*_amd64.deb
            asset_name: janus_*_amd64.deb
            asset_content_type: application/zip
      
        - uses: actions/upload-artifact@v3
          with:
            name: ubuntu
            path: staging

  job2:
    needs: job0
    
    runs-on: windows-latest
    permissions:
        contents: read
        packages: write

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 16
        uses: actions/setup-java@v2
        with:
          java-version: '16'
          distribution: 'temurin'
          cache: maven
      - run: mkdir daemon
      - run: mkdir staging
    
      - name: download daemon
        uses: duhow/download-github-release-assets@v1
        with:
          repository: unigrid-project/daemon
          release-id: latest
          files: unigrid-*-win64.zip
          target: unigridd.zip
      - name: Extract
        run: | 
          mkdir -p download/daemon && unzip unigridd.zip -d download/daemon && cp download/daemon/unigrid-*/bin/unigridd.exe src/main/resources/daemon
    
      - name: Build with Maven
        run: mvn install
      
      - run: cp target/release/*.* staging
      - run: cd staging && ls && cd ..
      
      - name: Download path from job0
        uses: actions/download-artifact@v3
        with:
          name: path
      - shell: bash
        run: |
          value='cat uploadPath.txt'

      - name: Upload release assets
        id: upload_realse_assets
        uses: actions/upload_release_asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.SKITPICKEL }}
        with:
          upload_url: value
          asset_path: ./staging/Janus-*.msi
          asset_name: Janus-*.msi
          asset_content_type: application/zip
      
      - uses: actions/upload-artifact@v3
        with:
          name: windows
          path: staging

  job3:
    needs: job0
    
    runs-on: macos-latest
    permissions:
        contents: read
        packages: write

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 16
        uses: actions/setup-java@v2
        with:
          java-version: '16'
          distribution: 'temurin'
          cache: maven


      - name: download daemon
        uses: duhow/download-github-release-assets@v1
        with:
          repository: unigrid-project/daemon
          release-id: latest
          files: unigrid-*-osx64.tar.gz
          target: unigridd.tar.gz
      - name: Extract
        run: | 
          mkdir -p target/daemon && tar -xvf unigridd.tar.gz -C target/daemon
      - run: cp target/daemon/unigrid-*/bin/unigridd src/main/resources/daemon    
      - name: Build with Maven
        run: mvn install
      
      - run: mkdir staging && cp target/release/*.* staging
      - run: cd staging && ls && cd ..
      
      - name: Download path from job0
        uses: actions/download-artifact@v3
        with:
          name: path
      - shell: bash
        run: |
          value='cat uploadPath.txt'

      - name: Upload release assets
        id: upload_realse_assets
        uses: actions/upload_release_asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.SKITPICKEL }}
        with:
          upload_url: value
          asset_path: ./staging/Janus-*.dmg
          asset_name: Janus-*.dmg
          asset_content_type: application/zip
        
      - uses: actions/upload-artifact@v3
        with:
          name: macos
          path: staging
